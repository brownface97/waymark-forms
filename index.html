<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Application Form - Waymark Immigration</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }

    .header h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .form-section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .form-section h2 {
      color: #333;
      font-size: 22px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #333;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .travel-entry, .family-member {
      background: white;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      margin-bottom: 15px;
      position: relative;
    }

    .remove-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .add-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .add-btn:hover {
      background: #218838;
    }

    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 30px;
      transition: transform 0.2s ease;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .auto-save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(40, 167, 69, 0.95);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .auto-save-indicator.show {
      opacity: 1;
    }

    .success-message {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin-top: 20px;
    }

    .error-message {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin-top: 20px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .radio-option input[type="radio"] {
      width: auto;
      margin: 0;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .header h1 {
        font-size: 24px;
      }

      .row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <div class="auto-save-indicator" id="autoSaveIndicator">‚úì Progress Saved</div>

  <div class="container">
    <div class="header">
      <h1>üá®üá¶ Waymark Immigration</h1>
      <p>Complete Application Form</p>
    </div>

    <!-- FORM TYPE SELECTION -->
    <div class="form-section">
      <h2>üìã Select Application Type</h2>
      <div class="form-group">
        <label for="formType">Form Type *</label>
        <select id="formType" onchange="loadFormTemplate()" required>
          <option value="">-- Select Form Type --</option>
          <optgroup label="Visitor & Temporary Resident">
            <option value="visitor_visa">Visitor Visa</option>
            <option value="visitor_visa_extension">Visitor Visa Extension</option>
            <option value="visitor_record">Visitor Record</option>
          </optgroup>
          <optgroup label="Study Permits">
            <option value="study_permit_inside">Study Permit (Inside Canada)</option>
            <option value="study_permit_outside">Study Permit (Outside Canada)</option>
            <option value="study_permit_extension">Study Permit Extension</option>
          </optgroup>
          <optgroup label="Work Permits">
            <option value="pgwp">Post-Graduation Work Permit (PGWP)</option>
            <option value="spousal_open_work_permit">Spousal Open Work Permit</option>
            <option value="work_permit_lmia_inside">LMIA Work Permit (Inside Canada)</option>
            <option value="work_permit_lmia_outside">LMIA Work Permit (Outside Canada)</option>
            <option value="work_permit_extension">Work Permit Extension</option>
            <option value="work_permit_lmia_exempt">LMIA-Exempt Work Permit</option>
          </optgroup>
          <optgroup label="Permanent Residence">
            <option value="express_entry">Express Entry (FSW/CEC/FST)</option>
            <option value="pnp_application">Provincial Nominee Program (PNP)</option>
            <option value="family_sponsorship">Family Sponsorship (Spousal/Parent/Child)</option>
            <option value="cec_application">Canadian Experience Class</option>
            <option value="fsw_application">Federal Skilled Worker</option>
            <option value="fst_application">Federal Skilled Trades</option>
          </optgroup>
          <optgroup label="Other Services">
            <option value="restoration_status">Restoration of Status</option>
            <option value="trp">Temporary Resident Permit</option>
            <option value="study_permit_coop">Study Permit with Co-op Work Permit</option>
          </optgroup>
        </select>
      </div>
    </div>

    <form id="applicationForm" onsubmit="submitForm(event)">

      <!-- PERSONAL INFORMATION -->
      <div class="form-section">
        <h2>üë§ Personal Information</h2>

        <div class="row">
          <div class="form-group">
            <label for="familyName">Family Name (Last Name)</label>
            <input type="text" id="familyName" name="familyName">
          </div>
          <div class="form-group">
            <label for="givenName">Given Name(s) (First Name)</label>
            <input type="text" id="givenName" name="givenName">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="dateOfBirth">Date of Birth</label>
            <input type="date" id="dateOfBirth" name="dateOfBirth">
          </div>
          <div class="form-group">
            <label for="placeOfBirth">Place of Birth (City, Country)</label>
            <input type="text" id="placeOfBirth" name="placeOfBirth">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="sex">Sex</label>
            <select id="sex" name="sex">
              <option value="">Select</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="another_gender">Another Gender</option>
            </select>
          </div>
          <div class="form-group">
            <label for="maritalStatus">Marital Status</label>
            <select id="maritalStatus" name="maritalStatus">
              <option value="">Select</option>
              <option value="single">Single</option>
              <option value="married">Married</option>
              <option value="common_law">Common-Law</option>
              <option value="divorced">Divorced</option>
              <option value="separated">Separated</option>
              <option value="widowed">Widowed</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="citizenship">Country of Citizenship</label>
            <input type="text" id="citizenship" name="citizenship">
          </div>
          <div class="form-group">
            <label for="passportNumber">Passport Number</label>
            <input type="text" id="passportNumber" name="passportNumber">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="passportIssueDate">Passport Issue Date</label>
            <input type="date" id="passportIssueDate" name="passportIssueDate">
          </div>
          <div class="form-group">
            <label for="passportExpiryDate">Passport Expiry Date</label>
            <input type="date" id="passportExpiryDate" name="passportExpiryDate">
          </div>
        </div>
      </div>

      <!-- CONTACT INFORMATION -->
      <div class="form-section">
        <h2>üìß Contact Information</h2>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email">
        </div>

        <div class="row">
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" name="phone">
          </div>
          <div class="form-group">
            <label for="alternatePhone">Alternate Phone</label>
            <input type="tel" id="alternatePhone" name="alternatePhone">
          </div>
        </div>

        <div class="form-group">
          <label for="currentAddress">Current Residential Address</label>
          <textarea id="currentAddress" name="currentAddress" rows="3"></textarea>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" name="city">
          </div>
          <div class="form-group">
            <label for="province">Province/State</label>
            <input type="text" id="province" name="province">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="postalCode">Postal/Zip Code</label>
            <input type="text" id="postalCode" name="postalCode">
          </div>
          <div class="form-group">
            <label for="country">Country</label>
            <input type="text" id="country" name="country">
          </div>
        </div>
      </div>

      <!-- TRAVEL HISTORY (LAST 5 YEARS) -->
      <div class="form-section">
        <h2>‚úàÔ∏è Travel History (Last 5 Years)</h2>
        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
          List all trips outside your country of residence in the last 5 years, including short trips.
        </p>

        <div id="travelHistoryContainer">
          <!-- Travel entries will be added here -->
        </div>

        <button type="button" class="add-btn" onclick="addTravelEntry()">
          + Add Travel Entry
        </button>
      </div>

      <!-- FAMILY INFORMATION -->
      <div class="form-section">
        <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Information</h2>

        <div class="form-group">
          <label>Number of Family Members (Including Spouse and Children)</label>
          <input type="number" id="numFamilyMembers" name="numFamilyMembers" min="0" max="20" value="0" onchange="generateFamilyFields()">
        </div>

        <div id="familyMembersContainer">
          <!-- Family member fields will be generated here -->
        </div>
      </div>

      <!-- EDUCATION -->
      <div class="form-section">
        <h2>üéì Education History</h2>

        <div class="form-group">
          <label for="highestEducation">Highest Level of Education</label>
          <select id="highestEducation" name="highestEducation">
            <option value="">Select</option>
            <option value="none">No Formal Education</option>
            <option value="high_school">High School Diploma</option>
            <option value="diploma">Diploma/Certificate (1-2 years)</option>
            <option value="bachelors">Bachelor's Degree</option>
            <option value="masters">Master's Degree</option>
            <option value="phd">Doctorate (PhD)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="educationDetails">Education Details (Institution, Program, Dates)</label>
          <textarea id="educationDetails" name="educationDetails" rows="4"></textarea>
        </div>
      </div>

      <!-- WORK EXPERIENCE -->
      <div class="form-section">
        <h2>üíº Work Experience</h2>

        <div class="form-group">
          <label for="currentOccupation">Current/Most Recent Occupation</label>
          <input type="text" id="currentOccupation" name="currentOccupation">
        </div>

        <div class="form-group">
          <label for="workExperience">Work Experience Details (Last 10 Years)</label>
          <textarea id="workExperience" name="workExperience" rows="5" placeholder="Job Title, Company, Dates (From - To), Duties"></textarea>
        </div>

        <div class="form-group">
          <label for="yearsOfExperience">Total Years of Work Experience</label>
          <input type="number" id="yearsOfExperience" name="yearsOfExperience" min="0" max="50" step="0.5">
        </div>
      </div>

      <!-- LANGUAGE PROFICIENCY -->
      <div class="form-section">
        <h2>üó£Ô∏è Language Proficiency</h2>

        <div class="form-group">
          <label>Do you have language test results? (IELTS, CELPIP, TEF, TCF)</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="languageTestYes" name="hasLanguageTest" value="yes" onchange="toggleLanguageFields(true)">
              <label for="languageTestYes" style="margin: 0;">Yes</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="languageTestNo" name="hasLanguageTest" value="no" onchange="toggleLanguageFields(false)">
              <label for="languageTestNo" style="margin: 0;">No</label>
            </div>
          </div>
        </div>

        <div id="languageTestFields" style="display: none;">
          <div class="row">
            <div class="form-group">
              <label for="languageTestType">Test Type</label>
              <select id="languageTestType" name="languageTestType">
                <option value="">Select</option>
                <option value="ielts">IELTS</option>
                <option value="celpip">CELPIP</option>
                <option value="tef">TEF Canada</option>
                <option value="tcf">TCF Canada</option>
              </select>
            </div>
            <div class="form-group">
              <label for="languageTestDate">Test Date</label>
              <input type="date" id="languageTestDate" name="languageTestDate">
            </div>
          </div>

          <div class="row">
            <div class="form-group">
              <label for="languageReading">Reading Score</label>
              <input type="text" id="languageReading" name="languageReading">
            </div>
            <div class="form-group">
              <label for="languageWriting">Writing Score</label>
              <input type="text" id="languageWriting" name="languageWriting">
            </div>
          </div>

          <div class="row">
            <div class="form-group">
              <label for="languageListening">Listening Score</label>
              <input type="text" id="languageListening" name="languageListening">
            </div>
            <div class="form-group">
              <label for="languageSpeaking">Speaking Score</label>
              <input type="text" id="languageSpeaking" name="languageSpeaking">
            </div>
          </div>
        </div>
      </div>

      <!-- STANDARD IRCC QUESTIONS -->
      <div class="form-section">
        <h2>‚ö†Ô∏è Background Questions</h2>
        <p style="color: #dc3545; margin-bottom: 20px; font-size: 14px; font-weight: 600;">
          These questions are required by IRCC for all applications. Please answer honestly.
        </p>

        <!-- Criminal Conviction -->
        <div class="form-group">
          <label>Have you ever been convicted of a crime or offense in any country?</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="convictionYes" name="hasConviction" value="yes" onchange="toggleConvictionDetails(true)">
              <label for="convictionYes" style="margin: 0;">Yes</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="convictionNo" name="hasConviction" value="no" onchange="toggleConvictionDetails(false)">
              <label for="convictionNo" style="margin: 0;">No</label>
            </div>
          </div>
        </div>

        <div id="convictionDetails" style="display: none; margin-top: 15px;">
          <div class="form-group">
            <label for="convictionExplanation">Please provide details (offense, date, location, sentence)</label>
            <textarea id="convictionExplanation" name="convictionExplanation" rows="4"></textarea>
          </div>
        </div>

        <!-- Health Condition -->
        <div class="form-group" style="margin-top: 25px;">
          <label>Do you have any serious health condition that may require medical treatment or social services in Canada?</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="healthIssueYes" name="hasHealthIssue" value="yes" onchange="toggleHealthDetails(true)">
              <label for="healthIssueYes" style="margin: 0;">Yes</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="healthIssueNo" name="hasHealthIssue" value="no" onchange="toggleHealthDetails(false)">
              <label for="healthIssueNo" style="margin: 0;">No</label>
            </div>
          </div>
        </div>

        <div id="healthDetails" style="display: none; margin-top: 15px;">
          <div class="form-group">
            <label for="healthExplanation">Please provide details</label>
            <textarea id="healthExplanation" name="healthExplanation" rows="4"></textarea>
          </div>
        </div>

        <!-- Previous Refusals -->
        <div class="form-group" style="margin-top: 25px;">
          <label>Have you ever been refused a visa or permit, denied entry, or ordered to leave Canada or any other country?</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="refusalYes" name="hasRefusal" value="yes" onchange="toggleRefusalDetails(true)">
              <label for="refusalYes" style="margin: 0;">Yes</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="refusalNo" name="hasRefusal" value="no" onchange="toggleRefusalDetails(false)">
              <label for="refusalNo" style="margin: 0;">No</label>
            </div>
          </div>
        </div>

        <div id="refusalDetails" style="display: none; margin-top: 15px;">
          <div class="form-group">
            <label for="refusalExplanation">Please provide details (country, date, type of application, reason)</label>
            <textarea id="refusalExplanation" name="refusalExplanation" rows="4"></textarea>
          </div>
        </div>

        <!-- Previous Application in Canada -->
        <div class="form-group" style="margin-top: 25px;">
          <label>Have you previously applied for permanent residence, a visa, or a permit to Canada?</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="previousAppYes" name="hasPreviousApplication" value="yes" onchange="togglePreviousAppDetails(true)">
              <label for="previousAppYes" style="margin: 0;">Yes</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="previousAppNo" name="hasPreviousApplication" value="no" onchange="togglePreviousAppDetails(false)">
              <label for="previousAppNo" style="margin: 0;">No</label>
            </div>
          </div>
        </div>

        <div id="previousAppDetails" style="display: none; margin-top: 15px;">
          <div class="form-group">
            <label for="previousAppExplanation">Please provide details (type, date, UCI number if available, outcome)</label>
            <textarea id="previousAppExplanation" name="previousAppExplanation" rows="4"></textarea>
          </div>
        </div>
      </div>

      <!-- ADDITIONAL INFORMATION -->
      <div class="form-section">
        <h2>üìù Additional Information</h2>

        <div class="form-group">
          <label for="additionalInfo">Any Additional Information or Special Circumstances</label>
          <textarea id="additionalInfo" name="additionalInfo" rows="5" placeholder="Please provide any additional information that may be relevant to your application..."></textarea>
        </div>
      </div>

      <!-- SUBMIT BUTTON -->
      <button type="submit" class="submit-btn" id="submitBtn">
        Submit Application
      </button>

      <div id="responseMessage"></div>
    </form>
  </div>

  <script>
    let travelEntryCount = 0;
    let autoSaveInterval;

    // Initialize form on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadSavedData();
      startAutoSave();
    });

    // Toggle language test fields
    function toggleLanguageFields(show) {
      document.getElementById('languageTestFields').style.display = show ? 'block' : 'none';
    }

    // Toggle conviction details
    function toggleConvictionDetails(show) {
      document.getElementById('convictionDetails').style.display = show ? 'block' : 'none';
    }

    // Toggle health details
    function toggleHealthDetails(show) {
      document.getElementById('healthDetails').style.display = show ? 'block' : 'none';
    }

    // Toggle refusal details
    function toggleRefusalDetails(show) {
      document.getElementById('refusalDetails').style.display = show ? 'block' : 'none';
    }

    // Toggle previous application details
    function togglePreviousAppDetails(show) {
      document.getElementById('previousAppDetails').style.display = show ? 'block' : 'none';
    }

    // Add travel entry
    function addTravelEntry() {
      travelEntryCount++;
      const container = document.getElementById('travelHistoryContainer');

      const entryDiv = document.createElement('div');
      entryDiv.className = 'travel-entry';
      entryDiv.id = `travel-${travelEntryCount}`;

      entryDiv.innerHTML = `
        <button type="button" class="remove-btn" onclick="removeTravelEntry(${travelEntryCount})">√ó</button>
        <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">Travel Entry #${travelEntryCount}</h3>

        <div class="form-group">
          <label>Country/Territory Visited</label>
          <input type="text" name="travelCountry_${travelEntryCount}" placeholder="e.g., United States">
        </div>

        <div class="row">
          <div class="form-group">
            <label>From Date</label>
            <input type="date" name="travelFromDate_${travelEntryCount}">
          </div>
          <div class="form-group">
            <label>To Date</label>
            <input type="date" name="travelToDate_${travelEntryCount}">
          </div>
        </div>

        <div class="form-group">
          <label>Purpose of Trip</label>
          <select name="travelPurpose_${travelEntryCount}">
            <option value="">Select Purpose</option>
            <option value="tourism">Tourism</option>
            <option value="business">Business</option>
            <option value="study">Study</option>
            <option value="work">Work</option>
            <option value="family_visit">Family Visit</option>
            <option value="medical">Medical Treatment</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label>Additional Details (Optional)</label>
          <textarea name="travelDetails_${travelEntryCount}" rows="2" placeholder="Any additional information about this trip..."></textarea>
        </div>
      `;

      container.appendChild(entryDiv);
    }

    // Remove travel entry
    function removeTravelEntry(id) {
      const entry = document.getElementById(`travel-${id}`);
      if (entry) {
        entry.remove();
      }
    }

    // Generate family member fields
    function generateFamilyFields() {
      const numMembers = parseInt(document.getElementById('numFamilyMembers').value) || 0;
      const container = document.getElementById('familyMembersContainer');
      container.innerHTML = '';

      for (let i = 1; i <= numMembers; i++) {
        const memberDiv = document.createElement('div');
        memberDiv.className = 'family-member';
        memberDiv.innerHTML = `
          <h3 style="color: #667eea; margin-bottom: 15px; font-size: 16px;">Family Member #${i}</h3>

          <div class="row">
            <div class="form-group">
              <label>Family Name</label>
              <input type="text" name="familyMemberLastName_${i}">
            </div>
            <div class="form-group">
              <label>Given Name</label>
              <input type="text" name="familyMemberFirstName_${i}">
            </div>
          </div>

          <div class="row">
            <div class="form-group">
              <label>Relationship</label>
              <select name="familyMemberRelationship_${i}">
                <option value="">Select</option>
                <option value="spouse">Spouse</option>
                <option value="common_law">Common-Law Partner</option>
                <option value="child">Child</option>
                <option value="parent">Parent</option>
                <option value="sibling">Sibling</option>
              </select>
            </div>
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" name="familyMemberDOB_${i}">
            </div>
          </div>

          <div class="form-group">
            <label>Will accompany you to Canada?</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="accompany_yes_${i}" name="familyMemberAccompany_${i}" value="yes">
                <label for="accompany_yes_${i}" style="margin: 0;">Yes</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="accompany_no_${i}" name="familyMemberAccompany_${i}" value="no">
                <label for="accompany_no_${i}" style="margin: 0;">No</label>
              </div>
            </div>
          </div>
        `;
        container.appendChild(memberDiv);
      }
    }

    // Load form template based on selection
    function loadFormTemplate() {
      const formType = document.getElementById('formType').value;
      // Form type is selected, you can customize fields based on type if needed
      console.log('Form type selected:', formType);
    }

    // Auto-save functionality
    function startAutoSave() {
      autoSaveInterval = setInterval(() => {
        saveFormData();
      }, 5000); // Save every 5 seconds
    }

    function saveFormData() {
      const form = document.getElementById('applicationForm');
      const formData = new FormData(form);
      const data = {};

      formData.forEach((value, key) => {
        data[key] = value;
      });

      // Include form type
      data.formType = document.getElementById('formType').value;

      // Save to localStorage
      localStorage.setItem('waymark_form_data', JSON.stringify(data));

      // Show auto-save indicator
      const indicator = document.getElementById('autoSaveIndicator');
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 2000);
    }

    function loadSavedData() {
      const savedData = localStorage.getItem('waymark_form_data');
      if (savedData) {
        const data = JSON.parse(savedData);

        // Restore form type
        if (data.formType) {
          document.getElementById('formType').value = data.formType;
        }

        // Restore all other fields
        Object.keys(data).forEach(key => {
          const field = document.querySelector(`[name="${key}"]`);
          if (field) {
            if (field.type === 'radio') {
              const radio = document.querySelector(`[name="${key}"][value="${data[key]}"]`);
              if (radio) radio.checked = true;
            } else {
              field.value = data[key];
            }
          }
        });
      }
    }

    // Submit form
    async function submitForm(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      const responseDiv = document.getElementById('responseMessage');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      responseDiv.innerHTML = '';

      // Collect form data
      const form = document.getElementById('applicationForm');
      const formData = new FormData(form);
      const data = {};

      formData.forEach((value, key) => {
        data[key] = value;
      });

      // Get form type
      const formType = document.getElementById('formType').value;
      const formName = document.getElementById('formType').options[document.getElementById('formType').selectedIndex].text;

      if (!formType) {
        responseDiv.innerHTML = '<div class="error-message">Please select a form type.</div>';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
        return;
      }

      // Collect travel history
      const travelHistory = [];
      for (let i = 1; i <= travelEntryCount; i++) {
        const country = document.querySelector(`[name="travelCountry_${i}"]`)?.value;
        if (country) {
          travelHistory.push({
            country: country,
            fromDate: document.querySelector(`[name="travelFromDate_${i}"]`)?.value,
            toDate: document.querySelector(`[name="travelToDate_${i}"]`)?.value,
            purpose: document.querySelector(`[name="travelPurpose_${i}"]`)?.value,
            details: document.querySelector(`[name="travelDetails_${i}"]`)?.value
          });
        }
      }
      data.travelHistory = travelHistory;

      // Prepare submission
      const submission = {
        formType: formType,
        formName: formName,
        data: data
      };

      try {
        // Submit to Cloudflare Worker
        const response = await fetch('https://waymark-forms.YOUR_SUBDOMAIN.workers.dev/api/submit-form', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(submission)
        });

        const result = await response.json();

        if (result.success) {
          responseDiv.innerHTML = `
            <div class="success-message">
              <h3>‚úì Application Submitted Successfully!</h3>
              <p>Submission ID: <strong>${result.submissionId}</strong></p>
              <p>${result.message}</p>
            </div>
          `;

          // Clear form and localStorage
          form.reset();
          localStorage.removeItem('waymark_form_data');
          document.getElementById('formType').value = '';
          document.getElementById('travelHistoryContainer').innerHTML = '';
          document.getElementById('familyMembersContainer').innerHTML = '';
          travelEntryCount = 0;
        } else {
          responseDiv.innerHTML = `<div class="error-message">Error: ${result.error}</div>`;
        }
      } catch (error) {
        console.error('Submission error:', error);
        responseDiv.innerHTML = '<div class="error-message">Failed to submit form. Please try again or contact us directly.</div>';
      }

      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Application';
    }
  </script>

</body>
</html>
