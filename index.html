<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waymark Immigration - Smart Application Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* Waymark Theme */
            --color-red: #D42426;
            --color-blue: #2563EB;
            --color-green: #059669;
            --color-orange: #F59E0B;
            --color-purple: #7C3AED;
            --color-dark: #1E293B;
            
            /* UI Variables */
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            
            --gradient-header: linear-gradient(135deg, rgba(30, 41, 59, 1) 0%, rgba(37, 99, 235, 1) 100%);
            --gradient-rainbow: linear-gradient(90deg, #D42426, #F59E0B, #059669, #2563EB, #7C3AED, #D42426);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 40px 20px;
            color: var(--color-dark);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--glass-shadow);
            border: 1px solid var(--glass-border);
            overflow: hidden;
        }

        .header {
            background: var(--gradient-header);
            color: white;
            padding: 40px 30px;
            text-align: center;
            border-bottom: 6px solid transparent;
            border-image: var(--gradient-rainbow) 1;
        }

        .logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 15px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        .header h1 { font-size: 32px; font-weight: 800; margin-bottom: 5px; }
        .header .subtitle { font-size: 16px; opacity: 0.9; }
        .rcic {
            background: rgba(255,255,255,0.15);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-top: 15px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* Controls */
        .controls {
            padding: 25px;
            background: rgba(255,255,255,0.6);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .controls label { font-size: 16px; margin-bottom: 10px; display: block; font-weight: 700; }
        
        select {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #cbd5e1;
            font-size: 16px;
            margin-bottom: 20px;
            font-weight: 600;
            background: white;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--color-blue); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(37,99,235,0.3); }

        .btn-save { background: var(--color-green); color: white; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(5,150,105,0.3); }

        .btn-outline { background: white; border: 1px solid #cbd5e1; color: var(--color-dark); }
        .btn-outline:hover { background: #f1f5f9; }

        .btn-add { background: var(--color-dark); color: white; padding: 10px 18px; font-size: 13px; }
        .btn-add:hover { background: var(--color-blue); }

        .btn-remove { background: #fee2e2; color: var(--color-red); padding: 5px 10px; font-size: 12px; }
        
        /* Form Content */
        .form-content { padding: 40px; }

        .form-section {
            background: rgba(255,255,255,0.8);
            border: 1px solid white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            position: relative;
        }

        /* Section Colors */
        .sec-personal { border-left: 6px solid var(--color-blue); }
        .sec-passport { border-left: 6px solid #0f172a; } /* New Passport Section Color */
        .sec-marital { border-left: 6px solid var(--color-purple); }
        .sec-contact { border-left: 6px solid var(--color-green); }
        .sec-temp { border-left: 6px solid var(--color-orange); }
        .sec-coming { border-left: 6px solid var(--color-dark); }
        .sec-history { border-left: 6px solid #64748b; }
        .sec-bg { border-left: 6px solid var(--color-red); }

        .section-title {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 25px;
            color: var(--color-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Grid Layouts */
        .row { display: grid; gap: 20px; margin-bottom: 20px; }
        .row-2 { grid-template-columns: 1fr 1fr; }
        .row-3 { grid-template-columns: 1fr 1fr 1fr; }
        .row-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }

        @media (max-width: 768px) {
            .row-2, .row-3, .row-4 { grid-template-columns: 1fr; }
            .form-content { padding: 20px; }
        }

        label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 14px; color: #334155; }
        .required { color: var(--color-red); }

        input, textarea, select {
            width: 100%;
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            font-size: 15px;
            background: white;
            font-family: inherit;
            color: #1e293b;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        /* Conditional Sections */
        .conditional { display: none; background: #f1f5f9; padding: 20px; border-radius: 12px; margin-top: 15px; border: 1px dashed #94a3b8; }
        .conditional.show { display: block; animation: fadeIn 0.3s; }

        /* Repeater Items */
        .repeater-item {
            background: white;
            padding: 25px;
            border-radius: 14px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .repeater-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .repeater-header strong { font-size: 16px; color: var(--color-blue); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <img src="https://primary.jwwb.nl/public/l/k/m/temp-sxbxntzjbvhbpwedrnga/untitled-5-5-high.png?enable-io=true&crop=1.3333%3A1&width=816" alt="Waymark Logo" class="logo">
            <h1>Waymark Immigration</h1>
            <p class="subtitle">Secure Client Application Portal</p>
            <div class="rcic">RCIC-IRB Licensed | R1034253</div>
        </div>

        <div class="controls">
            <label>Select Application Type <span class="required">*</span></label>
            <select id="formType" onchange="generateForm()">
                <option value="">-- Choose Application Document --</option>
                <option value="visitor_visa">Visitor Visa (TRV) - Outside Canada</option>
                <option value="visitor_record">Visitor Record (Extension) - Inside Canada</option>
                <option value="study_permit">Study Permit / Extension</option>
                <option value="work_permit">Work Permit (LMIA/PGWP/Open)</option>
                <option value="super_visa">Super Visa</option>
                <option value="pr_app">Permanent Residence</option>
                <option value="citizenship">Citizenship Application</option>
                <option value="sponsorship">Spousal Sponsorship</option>
                <option value="refugee">Refugee Claim</option>
            </select>

            <div class="action-bar">
                <button class="btn btn-save" onclick="downloadJSON()">üíæ Save to File (Resume Later)</button>
                <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">üìÇ Load from File</button>
                <input type="file" id="fileInput" accept=".json" onchange="loadJSON(this)">
                <button class="btn btn-outline" onclick="clearForm()">‚ôªÔ∏è Reset Form</button>
            </div>
        </div>

        <form id="mainForm">
            <div id="formContent" class="form-content">
                <div style="text-align:center; color:#64748b; padding:40px;">
                    <h3 style="margin-bottom:10px;">Welcome</h3>
                    <p>Please select an application type from the menu above to begin filling your form.</p>
                </div>
            </div>
            
            <div class="form-content" style="padding-top:0; display:none;" id="submitArea">
                <div class="form-section">
                    <button type="button" class="btn btn-primary" style="width:100%; justify-content:center; padding: 18px; font-size:18px;" onclick="submitForm()">Submit Application</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        let idx = { family: 0, work: 0, edu: 0, travel: 0, residence: 0 };

        function generateForm() {
            const type = document.getElementById('formType').value;
            const container = document.getElementById('formContent');
            const submitArea = document.getElementById('submitArea');
            
            if (!type) return;

            // Flags
            const isTempRes = ['visitor_visa', 'visitor_record', 'study_permit', 'work_permit', 'super_visa'].includes(type);
            const isInsideCanada = ['visitor_record', 'study_permit', 'work_permit'].includes(type);
            const isVisitor = type === 'visitor_visa';

            idx = { family: 0, work: 0, edu: 0, travel: 0, residence: 0 };

            let html = `
                <div class="form-section sec-personal">
                    <h2 class="section-title">Personal Details</h2>
                    <div class="row row-2">
                        <div><label>Given Name(s) <span class="required">*</span></label><input type="text" name="givenName"></div>
                        <div><label>Family Name <span class="required">*</span></label><input type="text" name="familyName"></div>
                    </div>
                    <div class="row row-3">
                        <div><label>Date of Birth <span class="required">*</span></label><input type="date" name="dob"></div>
                        <div><label>Place of Birth (City, Country) <span class="required">*</span></label><input type="text" name="pob"></div>
                        <div><label>UCI (Unique Client ID)</label><input type="text" name="uci"></div>
                    </div>
                </div>

                <div class="form-section sec-passport">
                    <h2 class="section-title">Passport / Travel Document</h2>
                    <div class="row row-2">
                        <div><label>Passport Number <span class="required">*</span></label><input type="text" name="pp_number"></div>
                        <div><label>Country of Issue <span class="required">*</span></label><input type="text" name="pp_country"></div>
                    </div>
                    <div class="row row-2">
                        <div><label>Issue Date <span class="required">*</span></label><input type="date" name="pp_issue"></div>
                        <div><label>Expiry Date <span class="required">*</span></label><input type="date" name="pp_expiry"></div>
                    </div>
                    
                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid #cbd5e1;">
                        <label>Do you have a National Identity Document? <span class="required">*</span></label>
                        <select name="has_nat_id" onchange="toggleNatId(this.value)">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select>
                    </div>
                    <div id="natIdInfo" class="conditional">
                        <div class="row row-2">
                            <div><label>Document Number</label><input type="text" name="nat_id_num"></div>
                            <div><label>Country of Issue</label><input type="text" name="nat_id_country"></div>
                        </div>
                        <div class="row row-2">
                            <div><label>Issue Date</label><input type="date" name="nat_id_issue"></div>
                            <div><label>Expiry Date</label><input type="date" name="nat_id_expiry"></div>
                        </div>
                    </div>
                </div>

                <div class="form-section sec-marital">
                    <h2 class="section-title">Marital Status</h2>
                    <div class="row">
                        <label>Current Marital Status <span class="required">*</span></label>
                        <select name="maritalStatus" id="maritalStatus" onchange="toggleMaritalFields()">
                            <option value="">Select Status</option>
                            <option value="single">Single / Never Married</option>
                            <option value="married">Married</option>
                            <option value="common_law">Common-Law</option>
                            <option value="separated">Separated</option>
                            <option value="divorced">Divorced</option>
                            <option value="widowed">Widowed</option>
                        </select>
                    </div>

                    <div id="spouseInfo" class="conditional">
                        <h4 style="margin-bottom:15px; color:var(--color-purple);">Spouse / Partner Information</h4>
                        <div class="row row-2">
                            <div><label>Spouse Given Name(s)</label><input type="text" name="spouseGivenName"></div>
                            <div><label>Spouse Family Name</label><input type="text" name="spouseFamilyName"></div>
                        </div>
                        <div class="row row-2">
                            <div><label>Date of Marriage/Relationship</label><input type="date" name="marriageDate"></div>
                        </div>
                    </div>

                    <div id="deceasedInfo" class="conditional">
                        <h4 style="margin-bottom:15px; color:var(--color-red);">Deceased Information</h4>
                        <div class="row row-3">
                            <div><label>Date of Death</label><input type="date" name="deathDate"></div>
                            <div><label>City/Town of Death</label><input type="text" name="deathCity"></div>
                            <div><label>Country of Death</label><input type="text" name="deathCountry"></div>
                        </div>
                    </div>
                </div>

                <div class="form-section sec-contact">
                    <h2 class="section-title">Contact Information</h2>
                    
                    <div class="row row-3">
                        <div style="grid-column: span 1;"><label>Unit / Apt #</label><input type="text" name="addr_unit"></div>
                        <div style="grid-column: span 2;"><label>Street Number <span class="required">*</span></label><input type="text" name="addr_num"></div>
                    </div>
                    
                    <div class="row">
                        <div><label>Street Name <span class="required">*</span></label><input type="text" name="addr_street"></div>
                    </div>

                    <div class="row row-2">
                        <div><label>City / Town <span class="required">*</span></label><input type="text" name="addr_city"></div>
                        <div><label>Country <span class="required">*</span></label><input type="text" name="addr_country"></div>
                    </div>

                    <div class="row row-2">
                        <div><label>Province / State <span class="required">*</span></label><input type="text" name="addr_province"></div>
                        <div><label>Postal / Zip Code</label><input type="text" name="addr_postal"></div>
                    </div>

                    <div class="row row-2" style="margin-top:20px; padding-top:20px; border-top:1px solid #e2e8f0;">
                        <div><label>Phone Number <span class="required">*</span></label><input type="text" name="phone"></div>
                        <div><label>Email Address <span class="required">*</span></label><input type="email" name="email"></div>
                    </div>
                </div>
            `;

            // 5. TEMP RESIDENCE + 6 MONTHS LOGIC
            if (isTempRes) {
                html += `
                <div class="form-section sec-temp">
                    <h2 class="section-title">Temporary Residence Details</h2>
                    
                    <div class="row row-2">
                        <div><label>Current Country of Residence</label><input type="text" name="currResCountry"></div>
                        <div><label>Legal Status (e.g. Worker, Student)</label><input type="text" name="currResStatus"></div>
                    </div>
                    <div class="row row-2">
                        <div><label>From Date</label><input type="date" name="currResFrom"></div>
                        <div><label>To Date</label><input type="date" name="currResTo"></div>
                    </div>

                    <div style="margin-top:20px; padding-top:20px; border-top:1px solid #cbd5e1;">
                        <label>Have you spent 6 months or more outside your country of citizenship or current residence in the past year?</label>
                        <select name="sixMonthsOutside" onchange="toggleSixMonths(this.value)">
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select>
                    </div>
                    
                    <div id="sixMonthsDetails" class="conditional">
                        <div class="repeater-header">
                            <h4 style="color:var(--color-orange);">Entries for time spent outside (6+ Months)</h4>
                            <button type="button" class="btn btn-add" onclick="addResidenceEntry()">+ Add Entry</button>
                        </div>
                        <div id="residenceList"></div>
                    </div>
                </div>`;
            }

            // 6. COMING INTO CANADA
            if (isInsideCanada) {
                html += `
                <div class="form-section sec-coming">
                    <h2 class="section-title">Coming Into Canada</h2>
                    <h4 style="color:var(--color-dark); margin-bottom:10px;">1. Original Entry</h4>
                    <div class="row row-2">
                        <div><label>Date of Original Entry <span class="required">*</span></label><input type="date" name="origEntryDate"></div>
                        <div><label>Place of Original Entry (Airport/City) <span class="required">*</span></label><input type="text" name="origEntryPlace"></div>
                    </div>
                    <div class="row">
                        <label>Original Purpose for Coming <span class="required">*</span></label>
                        <select name="origEntryPurpose">
                            <option value="">Select Purpose</option>
                            <option value="tourism">Tourism / Visit</option>
                            <option value="work">Work</option>
                            <option value="study">Study</option>
                            <option value="family">Family Visit</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <h4 style="color:var(--color-dark); margin:20px 0 10px;">2. Most Recent Entry (If different)</h4>
                    <div class="row row-2">
                        <div><label>Date of Recent Entry</label><input type="date" name="recentEntryDate"></div>
                        <div><label>Place of Recent Entry</label><input type="text" name="recentEntryPlace"></div>
                    </div>

                    <h4 style="color:var(--color-dark); margin:20px 0 10px;">3. Current Document</h4>
                    <div class="row">
                        <label>Document Number of most recent Visitor Record, Work/Study Permit <span class="required">*</span></label>
                        <input type="text" name="currentDocNum" placeholder="e.g. U12345678 or W123456789">
                    </div>
                </div>`;
            }

            // 7. HISTORY REPEATERS
            html += `
                <div class="form-section sec-history">
                    <div class="repeater-header">
                        <h2 class="section-title" style="margin:0;">Family Information</h2>
                        <button type="button" class="btn btn-add" onclick="addFamily()">+ Add Member</button>
                    </div>
                    <div id="familyList"></div>
                </div>

                <div class="form-section sec-history">
                    <div class="repeater-header">
                        <h2 class="section-title" style="margin:0;">Education History</h2>
                        <button type="button" class="btn btn-add" onclick="addEdu()">+ Add Education</button>
                    </div>
                    <div id="eduList"></div>
                </div>

                <div class="form-section sec-history">
                    <div class="repeater-header">
                        <h2 class="section-title" style="margin:0;">Work Experience (10 Years)</h2>
                        <button type="button" class="btn btn-add" onclick="addWork()">+ Add Job</button>
                    </div>
                    <div id="workList"></div>
                </div>
            `;

            if (isVisitor) {
                html += `
                <div class="form-section sec-history">
                    <div class="repeater-header">
                        <h2 class="section-title" style="margin:0;">Travel History (5 Years)</h2>
                        <button type="button" class="btn btn-add" onclick="addTravel()">+ Add Trip</button>
                    </div>
                    <div id="travelList"></div>
                </div>`;
            }

            // 8. BACKGROUND
            html += `
                <div class="form-section sec-bg">
                    <h2 class="section-title">Background Information</h2>
                    ${generateBgQuestion('bg_health', 'Have you ever had any serious medical condition?')}
                    ${generateBgQuestion('bg_criminal', 'Have you ever been charged/convicted of a criminal offence?')}
                    ${generateBgQuestion('bg_refusal', 'Have you ever been refused a visa, or ordered to leave Canada or any other country?')}
                    ${generateBgQuestion('bg_military', 'Have you ever served in the military or police force?')}
                </div>
            `;

            container.innerHTML = html;
            submitArea.style.display = 'block';

            // Init Repeater Defaults
            addFamily();
            addEdu();
            addWork();
            if(isVisitor) addTravel();
        }

        // --- Logic ---
        function toggleMaritalFields() {
            const status = document.getElementById('maritalStatus').value;
            const spouse = document.getElementById('spouseInfo');
            const deceased = document.getElementById('deceasedInfo');
            spouse.classList.remove('show'); deceased.classList.remove('show');
            if(['married', 'common_law', 'separated', 'divorced', 'widowed'].includes(status)) spouse.classList.add('show');
            if(status === 'widowed') deceased.classList.add('show');
        }

        function toggleSixMonths(val) {
            const div = document.getElementById('sixMonthsDetails');
            if(val === 'yes') {
                div.classList.add('show');
                if(idx.residence === 0) addResidenceEntry(); // Add first blank entry
            } else div.classList.remove('show');
        }

        function toggleNatId(val) {
            const div = document.getElementById('natIdInfo');
            if(val === 'yes') div.classList.add('show'); else div.classList.remove('show');
        }

        // --- REPEATER FUNCTIONS ---
        function addResidenceEntry() {
            idx.residence++;
            const html = `
            <div class="repeater-item" id="res_${idx.residence}">
                <div class="repeater-header">
                    <strong>Entry #${idx.residence}</strong>
                    <button type="button" class="btn btn-remove" onclick="removeEl('res_${idx.residence}')">Remove</button>
                </div>
                <div class="row row-2">
                    <div><label>Country Name</label><input type="text" name="res_country_${idx.residence}"></div>
                    <div><label>Status (e.g. Worker/Visitor)</label><input type="text" name="res_status_${idx.residence}"></div>
                </div>
                <div class="row row-2">
                    <div><label>From Date</label><input type="date" name="res_from_${idx.residence}"></div>
                    <div><label>To Date</label><input type="date" name="res_to_${idx.residence}"></div>
                </div>
                <div class="row">
                    <div><label>Purpose of Stay</label><input type="text" name="res_purpose_${idx.residence}"></div>
                </div>
            </div>`;
            document.getElementById('residenceList').insertAdjacentHTML('beforeend', html);
        }

        function addFamily() {
            idx.family++;
            const html = `
            <div class="repeater-item" id="fam_${idx.family}">
                <div class="repeater-header">
                    <strong>Member #${idx.family}</strong>
                    <button type="button" class="btn btn-remove" onclick="removeEl('fam_${idx.family}')">Remove</button>
                </div>
                <div class="row row-2">
                    <div><label>Full Name</label><input type="text" name="fam_name_${idx.family}"></div>
                    <div><label>Relationship</label>
                        <select name="fam_rel_${idx.family}">
                            <option value="">Select</option>
                            <option value="Father">Father</option>
                            <option value="Mother">Mother</option>
                            <option value="Child">Child</option>
                            <option value="Sibling">Sibling</option>
                        </select>
                    </div>
                </div>
                <div class="row row-2">
                    <div><label>Date of Birth</label><input type="date" name="fam_dob_${idx.family}"></div>
                    <div><label>Country of Residence</label><input type="text" name="fam_country_${idx.family}"></div>
                </div>
            </div>`;
            document.getElementById('familyList').insertAdjacentHTML('beforeend', html);
        }

        function addEdu() {
            idx.edu++;
            const html = `
            <div class="repeater-item" id="edu_${idx.edu}">
                <div class="repeater-header">
                    <strong>Education #${idx.edu}</strong>
                    <button type="button" class="btn btn-remove" onclick="removeEl('edu_${idx.edu}')">Remove</button>
                </div>
                <div class="row row-2">
                    <div><label>Institution Name</label><input type="text" name="edu_school_${idx.edu}"></div>
                    <div><label>Field of Study</label><input type="text" name="edu_field_${idx.edu}"></div>
                </div>
                <div class="row row-2">
                    <div><label>City/Town</label><input type="text" name="edu_city_${idx.edu}"></div>
                    <div><label>Country</label><input type="text" name="edu_country_${idx.edu}"></div>
                </div>
                <div class="row row-2">
                    <div><label>From Date</label><input type="date" name="edu_from_${idx.edu}"></div>
                    <div><label>To Date</label><input type="date" name="edu_to_${idx.edu}"></div>
                </div>
            </div>`;
            document.getElementById('eduList').insertAdjacentHTML('beforeend', html);
        }

        function addWork() {
            idx.work++;
            const html = `
            <div class="repeater-item" id="work_${idx.work}">
                <div class="repeater-header">
                    <strong>Job #${idx.work}</strong>
                    <button type="button" class="btn btn-remove" onclick="removeEl('work_${idx.work}')">Remove</button>
                </div>
                <div class="row row-2">
                    <div><label>Company/Employer Name</label><input type="text" name="work_comp_${idx.work}"></div>
                    <div><label>Job Title</label><input type="text" name="work_title_${idx.work}"></div>
                </div>
                <div class="row row-2">
                    <div><label>City/Town</label><input type="text" name="work_city_${idx.work}"></div>
                    <div><label>Country</label><input type="text" name="work_country_${idx.work}"></div>
                </div>
                <div class="row row-2">
                    <div><label>From Date</label><input type="date" name="work_from_${idx.work}"></div>
                    <div><label>To Date (Leave blank if current)</label><input type="date" name="work_to_${idx.work}"></div>
                </div>
            </div>`;
            document.getElementById('workList').insertAdjacentHTML('beforeend', html);
        }

        function addTravel() {
            idx.travel++;
            const html = `
            <div class="repeater-item" id="trav_${idx.travel}">
                <div class="repeater-header">
                    <strong>Trip #${idx.travel}</strong>
                    <button type="button" class="btn btn-remove" onclick="removeEl('trav_${idx.travel}')">Remove</button>
                </div>
                <div class="row row-2">
                    <div><label>Country Visited</label><input type="text" name="trav_country_${idx.travel}"></div>
                    <div><label>Purpose of Travel</label><input type="text" name="trav_purpose_${idx.travel}"></div>
                </div>
                <div class="row row-2">
                    <div><label>From Date</label><input type="date" name="trav_from_${idx.travel}"></div>
                    <div><label>To Date</label><input type="date" name="trav_to_${idx.travel}"></div>
                </div>
            </div>`;
            document.getElementById('travelList').insertAdjacentHTML('beforeend', html);
        }

        function removeEl(id) { document.getElementById(id).remove(); }

        function generateBgQuestion(name, text) {
            return `
            <div style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #e2e8f0;">
                <p style="font-weight:700; margin-bottom:10px;">${text}</p>
                <div style="margin-bottom:10px;">
                    <label style="display:inline-block; margin-right:20px; font-weight:500;"><input type="radio" name="${name}" value="no" onclick="document.getElementById('d_${name}').style.display='none'"> No</label>
                    <label style="display:inline-block; font-weight:500;"><input type="radio" name="${name}" value="yes" onclick="document.getElementById('d_${name}').style.display='block'"> Yes</label>
                </div>
                <div id="d_${name}" style="display:none;">
                    <label>Provide Details:</label>
                    <textarea name="${name}_detail" rows="3"></textarea>
                </div>
            </div>`;
        }

        // --- SAVE / LOAD ---
        function downloadJSON() {
            const form = document.getElementById('mainForm');
            const formData = new FormData(form);
            const data = { formType: document.getElementById('formType').value };
            for(let [k,v] of formData.entries()) data[k] = v;
            
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            a.download = "waymark_form.json";
            document.body.appendChild(a); a.click(); a.remove();
        }

        function loadJSON(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = function(e) {
                const data = JSON.parse(e.target.result);
                document.getElementById('formType').value = data.formType;
                generateForm();
                setTimeout(() => {
                    Object.keys(data).forEach(k => {
                        const el = document.querySelector(`[name="${k}"]`);
                        if(el) {
                            if(el.type === 'radio') {
                                document.querySelector(`[name="${k}"][value="${data[k]}"]`).click();
                            } else {
                                el.value = data[k];
                            }
                        }
                    });
                    // Trigger Logic
                    toggleMaritalFields();
                    if(data.sixMonthsOutside) toggleSixMonths(data.sixMonthsOutside);
                    if(data.has_nat_id) toggleNatId(data.has_nat_id);

                }, 100);
            };
            r.readAsText(file);
        }

        function clearForm() { if(confirm("Reset form?")) { document.getElementById('mainForm').reset(); generateForm(); } }
        function submitForm() { alert("Ready to Submit."); }
    </script>
</body>
</html>
